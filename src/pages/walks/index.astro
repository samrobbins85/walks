---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import WalkCard from "../../components/walkCard.astro";

const walks = await getCollection("walks");
const tags = await getCollection("tags");
const sortedWalks = walks.sort(
      (a, b) => b.data.date.getTime() - a.data.date.getTime()
    );
const totalDistance = walks.reduce((p,c)=>p+c.data.length, 0)
const totalElevation = walks.reduce((p,c)=>p+c.data.elevation, 0)
---
<Layout>
  <div class="pt-6" x-data="{
    activeTag: 'all',
    init() {
          const params = new URLSearchParams(window.location.search);
          this.activeTag = params.get('tag') || 'all';
          this.$watch('activeTag', value => {
            const url = new URL(window.location);
            if (value === 'all') {
              url.searchParams.delete('tag');
            } else {
              url.searchParams.set('tag', value);
            }
            history.replaceState(null, '', url);
          });
        }
    }"
  >
    <h1 class="text-4xl font-light mb-6">Walks</h1>
    <div class="grid md:grid-cols-3 rounded-lg mb-4 gap-6 ">
      <div class="flex flex-col-reverse border px-6 py-4 border-slate-200 rounded-lg"><span class="text-2xl font-medium">{Math.round(totalDistance)} km</span> <span class="text-slate-500">Total distance</span></div>
      <div class="flex flex-col-reverse border px-6 py-4 border-slate-200 rounded-lg"><span class="text-2xl font-medium">{sortedWalks.length}</span> <span class="text-slate-500">Walks</span></div>
      <div class="flex flex-col-reverse border px-6 py-4 border-slate-200 rounded-lg"><span class="text-2xl font-medium">{totalElevation} m</span><span class="text-slate-500">Total ascent</span></div>
    </div>
    <div class="flex gap-3 pb-4 flex-wrap">
      <button
        @click="activeTag = 'all'"
        :class="{ 'bg-green-500 text-white': activeTag === 'all', 'bg-slate-100 hover:bg-slate-200  text-slate-600 hover:text-slate-900': activeTag !== 'all' }"
        class="cursor-pointer px-3 py-1.5 rounded-full text-sm font-medium transition-colors"
      >All</button>
      {
        tags.map((tagItem) => (
          <button
            @click={`activeTag = '${tagItem.id}'`}
            :class={`{ 'bg-green-500 text-white': activeTag === '${tagItem.id}',  'bg-slate-100 hover:bg-slate-200  text-slate-600 hover:text-slate-900': activeTag !== '${tagItem.id}'}`}
            class="cursor-pointer px-3 py-1.5 rounded-full text-sm font-medium transition-colors"
          >
            {tagItem.data.name}
          </button>
        ))
      }
    </div>

    <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-8">
      {
        sortedWalks.map((walk) => {
          const tagIds = walk.data.tags?.map(t => t.id) ?? [];
          const tagIdsExpr = `['${tagIds.join("','")}']`; 
          return (
            <li
              x-show={`activeTag === 'all' || ${tagIdsExpr}.includes(activeTag)`}
            >
              <WalkCard walk={walk} />
            </li>
          );
        })
      }
    </ul>
  </div>


</Layout>
